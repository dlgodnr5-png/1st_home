<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ìœ íŠœë¸Œ ë¡±í¼ ê¸°íšì (20ì¥ êµ¬ì„±)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f8fafc; }
        .card { background: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); padding: 24px; margin-bottom: 24px; }
        .btn-primary { background-color: #ff0000; color: white; transition: all 0.2s; }
        .btn-primary:hover { background-color: #cc0000; transform: translateY(-1px); }
        textarea { resize: vertical; min-height: 100px; }
        .api-badge { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; font-weight: bold; text-transform: uppercase; }
        .bg-openai { background-color: #10a37f; color: white; }
        .bg-youtube { background-color: #ff0000; color: white; }
        
        .script-textarea {
            width: 100%;
            height: 550px;
            padding: 24px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            background-color: #fffaf0;
            font-family: 'Noto Serif KR', serif;
            font-size: 1.15rem;
            line-height: 1.9;
            color: #2d3748;
            resize: none;
            overflow-y: scroll;
            white-space: pre-wrap;
        }
        .chapter-btn.active {
            border-color: #ff0000;
            background-color: #fff5f5;
            box-shadow: 0 0 0 2px rgba(255, 0, 0, 0.1);
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-6xl mx-auto">
        <header class="mb-8 text-center">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">ğŸ¬ YouTube 10M View Master Planner</h1>
            <p class="text-gray-600 font-medium">ì°¸ê³  ì˜ìƒì˜ êµ¬ì¡°ë§Œ í•™ìŠµí•˜ì—¬ ì°½ì¡°ì ì¸ 20ì¥ ë¶„ëŸ‰ì˜ ëŒ€ë³¸ì„ ì„¤ê³„í•©ë‹ˆë‹¤.</p>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- ì„¤ì • ì˜ì—­ -->
            <div class="md:col-span-1">
                <div class="card sticky top-8">
                    <h2 class="text-xl font-bold mb-4 flex items-center">âš™ï¸ í”„ë¡œì íŠ¸ ì„¤ì •</h2>
                    <div class="space-y-4">
                        <div>
                            <div class="flex justify-between items-center mb-1">
                                <label class="block text-sm font-medium text-gray-700">OpenAI API Key</label>
                                <span class="api-badge bg-openai">Required</span>
                            </div>
                            <input type="password" id="openaiKey" class="w-full p-2 border rounded text-sm outline-none focus:ring-2 focus:ring-green-500" placeholder="sk-...">
                        </div>
                        <div>
                            <div class="flex justify-between items-center mb-1">
                                <label class="block text-sm font-medium text-gray-700">YouTube API Key</label>
                                <span class="api-badge bg-youtube">Required</span>
                            </div>
                            <input type="password" id="youtubeKey" class="w-full p-2 border rounded text-sm outline-none focus:ring-2 focus:ring-red-500" placeholder="AIzaSy...">
                        </div>
                        <hr>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ì°¸ê³ ìš© ìœ íŠœë¸Œ ì£¼ì†Œ (êµ¬ì¡° ë¶„ì„ìš©)</label>
                            <input type="text" id="refYoutubeUrl" class="w-full p-2 border rounded text-sm" placeholder="https://youtube.com/watch?v=...">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">í•µì‹¬ ì£¼ì œ</label>
                            <textarea id="mainTopic" class="w-full p-2 border rounded text-sm" placeholder="ì˜ìƒì˜ í•µì‹¬ ì£¼ì œë¥¼ ì…ë ¥í•˜ì„¸ìš”."></textarea>
                        </div>
                        <button onclick="generateOverallPlan()" id="generateBtn" class="w-full py-3 btn-primary rounded-lg font-bold shadow-lg">
                            ì „ì²´ ì‹œë†‰ì‹œìŠ¤(20ì¥) ê¸°íší•˜ê¸°
                        </button>
                    </div>
                </div>
            </div>

            <!-- ê²°ê³¼ ì¶œë ¥ ì„¹ì…˜ -->
            <div class="md:col-span-2 space-y-6">
                <div id="loadingStatus" class="hidden card flex flex-col items-center justify-center py-12">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-red-600 mb-4"></div>
                    <p id="loadingText" class="text-gray-600 font-medium italic text-center px-4"></p>
                </div>

                <!-- 1. ì¸ë„¤ì¼ & ë©”íƒ€ë°ì´í„° -->
                <div id="thumbnailSection" class="card hidden">
                    <h2 class="text-xl font-bold mb-4 text-red-600">ğŸ¨ 1. ë§ˆì¼€íŒ… íŒ¨í‚¤ì§€</h2>
                    <div class="space-y-4">
                        <div class="bg-gray-50 p-4 rounded-lg border">
                            <h3 class="font-bold text-sm mb-3 text-blue-700">ğŸ–¼ï¸ ì¸ë„¤ì¼ í”„ë¡¬í”„íŠ¸ (í•œêµ­ì¸/í•œêµ­ ë°°ê²½)</h3>
                            <div class="space-y-2">
                                <p class="text-sm font-mono p-3 bg-white border rounded select-all" id="promptEn"></p>
                                <p class="text-sm text-gray-700 p-3 bg-white border rounded" id="promptKo"></p>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="p-3 border rounded bg-red-50"><h3 class="font-bold text-xs mb-1">ğŸª í›„í‚¹ ë¬¸êµ¬</h3><p id="hookLine" class="font-bold"></p></div>
                            <div class="p-3 border rounded bg-gray-50"><h3 class="font-bold text-xs mb-1">ğŸ·ï¸ ì¶”ì²œ íƒœê·¸</h3><p id="tags" class="text-xs"></p></div>
                        </div>
                    </div>
                </div>

                <!-- 2. 20ì¥ ì‹œë†‰ì‹œìŠ¤ ë¦¬ìŠ¤íŠ¸ -->
                <div id="synopsisSection" class="card hidden">
                    <h2 class="text-xl font-bold mb-4 text-red-600">ğŸ“ 2. ì „ì²´ íë¦„ (20ì¥ êµ¬ì„±)</h2>
                    <p class="text-xs text-gray-500 mb-4">* ê° ì¥ì„ í´ë¦­í•˜ë©´ í•´ë‹¹ ì¥ì˜ ìƒì„¸ ëŒ€ë³¸(1,000ì)ì„ ì‹¤ì‹œê°„ìœ¼ë¡œ ì‘ì„±í•©ë‹ˆë‹¤.</p>
                    <div id="chaptersList" class="grid grid-cols-1 sm:grid-cols-2 gap-3"></div>
                </div>

                <!-- 3. ìƒì„¸ ëŒ€ë³¸ ìƒì„±ê¸° -->
                <div id="detailSection" class="card hidden border-2 border-red-100">
                    <div class="flex justify-between items-center mb-6 border-b pb-4">
                        <h2 class="text-xl font-bold text-red-600">ğŸ™ï¸ ì¥ë³„ ìƒì„¸ ëŒ€ë³¸</h2>
                        <span id="currentChapterTitle" class="bg-red-600 text-white px-4 py-1 rounded-full text-sm font-bold shadow-sm"></span>
                    </div>
                    
                    <div id="scriptLoading" class="hidden py-10 text-center">
                        <div class="animate-pulse flex flex-col items-center">
                            <div class="h-8 w-48 bg-gray-200 rounded mb-4"></div>
                            <p class="text-sm text-gray-500 italic">AIê°€ ëŒ€ë³¸ 1,000ìë¥¼ ì •êµí•˜ê²Œ ì§‘í•„ ì¤‘ì…ë‹ˆë‹¤...</p>
                        </div>
                    </div>

                    <div id="scriptContainer" class="space-y-8">
                        <div>
                            <h3 class="font-bold text-base mb-3 flex items-center text-gray-800 italic">
                                1ì¸ì¹­ ì˜¤ë””ì˜¤ë¶ ëŒ€ë³¸ (ì•½ 1,000ì)
                            </h3>
                            <textarea id="scriptContentArea" class="script-textarea" readonly placeholder="ì‹œë†‰ì‹œìŠ¤ë¥¼ í´ë¦­í•˜ë©´ ëŒ€ë³¸ì´ ìƒì„±ë©ë‹ˆë‹¤."></textarea>
                        </div>
                        <div class="bg-gray-100 p-4 rounded-lg border">
                            <h3 class="font-bold text-sm mb-2">ğŸ–¼ï¸ ì¥ë³„ ì´ë¯¸ì§€ í”„ë¡¬í”„íŠ¸ (í•œêµ­ì  ë°°ê²½)</h3>
                            <p id="scenePromptEn" class="text-xs font-mono text-blue-800 mb-2"></p>
                            <p id="scenePromptKo" class="text-xs text-gray-600"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let fullSynopsis = [];
        let generatedScripts = {}; // { chapterIndex: { script, promptEn, promptKo } }
        let currentIdx = -1;
        let mainTopicGlobal = "";
        let contextGlobal = "";

        window.onload = function() {
            document.getElementById('openaiKey').value = localStorage.getItem('openaiKey') || '';
            document.getElementById('youtubeKey').value = localStorage.getItem('youtubeKey') || '';
        };

        async function generateOverallPlan() {
            const openaiKey = document.getElementById('openaiKey').value;
            const youtubeKey = document.getElementById('youtubeKey').value;
            const refUrl = document.getElementById('refYoutubeUrl').value;
            const topic = document.getElementById('mainTopic').value;

            if (!openaiKey || !topic) return alert("í•„ìˆ˜ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            localStorage.setItem('openaiKey', openaiKey);
            localStorage.setItem('youtubeKey', youtubeKey);
            mainTopicGlobal = topic;

            const loadingStatus = document.getElementById('loadingStatus');
            const loadingText = document.getElementById('loadingText');
            loadingStatus.classList.remove('hidden');
            loadingText.innerText = "ì°¸ê³  ì˜ìƒì˜ êµ¬ì¡°ë¥¼ ë¶„ì„í•˜ê³  20ë‹¨ê³„ì˜ í•œê¸€ ì‹œë†‰ì‹œìŠ¤ë¥¼ ê¸°íš ì¤‘ì…ë‹ˆë‹¤...";

            try {
                let youtubeContext = "No specific YouTube data.";
                if (refUrl.includes('v=') && youtubeKey) {
                    const videoId = refUrl.split('v=')[1].split('&')[0];
                    const ytRes = await fetch(`https://www.googleapis.com/youtube/v3/videos?part=snippet&id=${videoId}&key=${youtubeKey}`);
                    const ytData = await ytRes.json();
                    if (ytData.items?.length > 0) youtubeContext = `Structure Source: ${ytData.items[0].snippet.title}, ${ytData.items[0].snippet.description}`;
                }
                contextGlobal = youtubeContext;

                const systemPrompt = `You are a legendary YouTube content engineer.
                Task: Create an OVERALL plan for a 20-chapter story.
                IMPORTANT:
                1. NEVER copy characters, names, or specific plot points from the context. Only analyze the 'structure'.
                2. Creatively invent ENTIRELY NEW names, Korean settings, and story arcs.
                3. The titles and summaries for the synopsis MUST BE IN KOREAN.
                4. The output must be exactly 20 chapter summaries.
                5. Output JSON ONLY.`;

                const userQuery = `Topic: ${topic}\nReference Structure: ${youtubeContext}\n
                Generate JSON in Korean:
                {
                  "thumbnail": { "promptEn": "...", "promptKo": "...", "hookLine": "...", "tags": "..." },
                  "synopsis": [ {"chapter": 1, "title": "(Korean Title)", "summary": "(Korean Summary)"}, ... (until 20) ]
                }`;

                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${openaiKey}` },
                    body: JSON.stringify({
                        model: "gpt-4o",
                        messages: [{ role: "system", content: systemPrompt }, { role: "user", content: userQuery }],
                        response_format: { type: "json_object" }
                    })
                });

                const data = await response.json();
                const result = JSON.parse(data.choices[0].message.content);
                
                renderOverallPlan(result);
            } catch (e) {
                alert("ê¸°íš ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ. API í‚¤ì™€ ë„¤íŠ¸ì›Œí¬ë¥¼ í™•ì¸í•˜ì„¸ìš”.");
            } finally {
                loadingStatus.classList.add('hidden');
            }
        }

        function renderOverallPlan(data) {
            document.getElementById('thumbnailSection').classList.remove('hidden');
            document.getElementById('promptEn').innerText = data.thumbnail.promptEn;
            document.getElementById('promptKo').innerText = data.thumbnail.promptKo;
            document.getElementById('hookLine').innerText = data.thumbnail.hookLine;
            document.getElementById('tags').innerText = data.thumbnail.tags;

            document.getElementById('synopsisSection').classList.remove('hidden');
            const list = document.getElementById('chaptersList');
            list.innerHTML = '';
            fullSynopsis = data.synopsis;
            generatedScripts = {}; // ì´ˆê¸°í™”

            data.synopsis.forEach((item, index) => {
                const btn = document.createElement('button');
                btn.id = `chapter-btn-${index}`;
                btn.className = "chapter-btn text-left p-3 border rounded-lg bg-white hover:shadow-md transition-all text-sm";
                btn.onclick = () => selectChapter(index);
                btn.innerHTML = `<span class="font-bold text-red-600 mr-2">${item.chapter}.</span> ${item.title}`;
                list.appendChild(btn);
            });
        }

        async function selectChapter(index) {
            currentIdx = index;
            // UI ì—…ë°ì´íŠ¸
            document.querySelectorAll('.chapter-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`chapter-btn-${index}`).classList.add('active');
            
            document.getElementById('detailSection').classList.remove('hidden');
            document.getElementById('currentChapterTitle').innerText = `${fullSynopsis[index].chapter}ì¥. ${fullSynopsis[index].title}`;

            if (generatedScripts[index]) {
                displayScript(generatedScripts[index]);
            } else {
                await generateChapterScript(index);
            }
        }

        async function generateChapterScript(index) {
            const openaiKey = document.getElementById('openaiKey').value;
            const scriptLoading = document.getElementById('scriptLoading');
            const scriptContainer = document.getElementById('scriptContainer');
            
            scriptLoading.classList.remove('hidden');
            scriptContainer.classList.add('opacity-30');
            document.getElementById('scriptContentArea').value = "";

            const chapterInfo = fullSynopsis[index];
            const prevContext = index > 0 ? `Previous summary: ${fullSynopsis[index-1].summary}` : "This is the start.";

            try {
                const systemPrompt = `You are writing a detailed 1st person audiobook script for YouTube (Chapter ${chapterInfo.chapter}/20).
                - Target Length: Approximately 1,000 Korean characters. 
                - Style: Emotional, immersive, vivid descriptions.
                - Consistency: Follow the overall story arc but focus ONLY on this chapter's events.
                - Setting: Completely NEW Korean story (names, locations).
                - Image: Must be Photorealistic, Korean character, Korean background.
                - The script MUST be written in Korean.
                Output JSON ONLY.`;

                const userQuery = `Main Topic: ${mainTopicGlobal}\nChapter Title: ${chapterInfo.title}\nChapter Summary: ${chapterInfo.summary}\n${prevContext}\n
                Generate JSON in Korean:
                { "script": "(1,000 character Korean script)", "scenePromptEn": "...", "scenePromptKo": "..." }`;

                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${openaiKey}` },
                    body: JSON.stringify({
                        model: "gpt-4o",
                        messages: [{ role: "system", content: systemPrompt }, { role: "user", content: userQuery }],
                        response_format: { type: "json_object" }
                    })
                });

                const data = await response.json();
                const result = JSON.parse(data.choices[0].message.content);
                generatedScripts[index] = result;
                displayScript(result);
            } catch (e) {
                alert("ëŒ€ë³¸ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            } finally {
                scriptLoading.classList.add('hidden');
                scriptContainer.classList.remove('opacity-30');
            }
        }

        function displayScript(data) {
            document.getElementById('scriptContentArea').value = data.script;
            document.getElementById('scenePromptEn').innerText = data.scenePromptEn;
            document.getElementById('scenePromptKo').innerText = data.scenePromptKo;
            document.getElementById('detailSection').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    </script>
</body>
</html>
